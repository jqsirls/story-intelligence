#!/bin/bash
# Pre-commit hook: Inclusivity System Protection
# Prevents commits that would compromise the 39-trait inclusivity system

echo "ğŸ” Checking inclusivity system integrity..."

# Check trait count in database
TRAIT_COUNT=$(grep -c "id: '" lambda-deployments/content-agent/src/constants/ComprehensiveInclusivityDatabase.ts 2>/dev/null || echo "0")

if [ "$TRAIT_COUNT" -lt 39 ]; then
  echo ""
  echo "âŒ COMMIT BLOCKED: Inclusivity System Violation"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  Traits found: $TRAIT_COUNT"
  echo "  Expected: 39+"
  echo "  Children excluded: $((39 - TRAIT_COUNT)) groups"
  echo ""
  echo "  EVERY child matters. NO EXCEPTIONS."
  echo ""
  echo "  Fix: Restore all 39 traits from git history before committing."
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  exit 1
fi

# Check for TODO/FIXME/PLACEHOLDER in critical files
CRITICAL_FILES=(
  "lambda-deployments/content-agent/src/constants/ComprehensiveInclusivityDatabase.ts"
  "lambda-deployments/content-agent/src/services/CharacterImageGenerator.ts"
  "lambda-deployments/content-agent/src/constants/SpeciesAnatomyProfiles.ts"
)

for file in "${CRITICAL_FILES[@]}"; do
  if [ -f "$file" ]; then
    PLACEHOLDERS=$(grep -E "TODO|FIXME|PLACEHOLDER|TBD" "$file" 2>/dev/null || echo "")
    if [ -n "$PLACEHOLDERS" ]; then
      echo ""
      echo "âŒ COMMIT BLOCKED: Placeholders Found"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  File: $file"
      echo ""
      echo "  Placeholders mean children excluded NOW (not 'later')."
      echo "  'Future PR' never happens. Complete it NOW."
      echo ""
      echo "  Fix: Complete the implementation before committing."
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      exit 1
    fi
  fi
done

# Check for deletion of critical inclusivity files
DELETED_FILES=$(git diff --cached --name-status | grep -E "^D.*(ComprehensiveInclusivityDatabase|CharacterImageGenerator|SpeciesAnatomyProfiles)\.ts" || echo "")

if [ -n "$DELETED_FILES" ]; then
  echo ""
  echo "âŒ COMMIT BLOCKED: Critical File Deletion Attempt"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  Attempting to delete critical inclusivity files"
  echo ""
  echo "  These files represent:"
  echo "  - 9 months of iteration"
  echo "  - 39 groups of children"
  echo "  - \$10,000+ in API testing costs"
  echo ""
  echo "  If you truly need to delete, remove this hook."
  echo "  But know that you are excluding children from stories."
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  exit 1
fi

# All checks passed
echo "âœ… Inclusivity system intact ($TRAIT_COUNT traits)"
echo ""

exit 0
