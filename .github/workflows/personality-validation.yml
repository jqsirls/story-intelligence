name: ğŸ­ Personality Validation
on: 
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'supabase/migrations/**'
      - 'supabase/schema.sql'
      - 'supabase/config.toml'
      - 'supabase/.env'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'supabase/migrations/**'
      - 'supabase/schema.sql'
      - 'supabase/config.toml'
      - 'supabase/.env'

jobs:
  validate-personality:
    name: ğŸ¯ Story Intelligenceâ„¢ Brand Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸš¨ Check for forbidden AI terminology
        run: |
          echo "ğŸ” Scanning for forbidden terminology..."
          
          # Check for AI-powered and variations
          if grep -r "AI-powered\|AI-driven\|AI-led" --include="*.ts" --include="*.js" --include="*.md" .; then
            echo "âŒ VIOLATION: Forbidden AI terminology found"
            echo "ğŸ’¡ Use 'Story Intelligenceâ„¢ powered' instead of 'AI-powered'"
            echo "ğŸ’¡ Use 'Story Intelligenceâ„¢ enhanced' instead of 'AI-driven'"
            exit 1
          fi
          
          # Check for personalized (should be age-appropriate)
          if grep -r "personalized" --include="*.ts" --include="*.js" --include="*.md" .; then
            echo "âŒ VIOLATION: 'personalized' found - use 'age-appropriate' instead"
            exit 1
          fi
          
          # Check for business jargon
          if grep -r "optimize\|leverage\|utilize\|solutioning" --include="*.ts" --include="*.js" .; then
            echo "âŒ VIOLATION: Business jargon found - use simple, clear language"
            exit 1
          fi
          
          echo "âœ… No forbidden terminology found"
          
      - name: ğŸ“ Validate sentence length in key files
        run: |
          echo "ğŸ” Checking sentence length in user-facing content..."
          
          # Check README files for long sentences
          find . -name "README.md" -exec awk '
            /^[^#]/ { 
              gsub(/[.!?]+/, ".|", $0); 
              split($0, sentences, "|"); 
              for (i in sentences) {
                if (gsub(/ /, " ", sentences[i]) > 18) {
                  print FILENAME ":" NR ": Sentence too long (" gsub(/ /, " ", sentences[i]) " words): " sentences[i];
                  exit 1;
                }
              }
            }' {} \;
          
          echo "âœ… Sentence length validation passed"
          
      - name: ğŸ¯ Check Story Intelligenceâ„¢ branding consistency
        run: |
          echo "ğŸ” Validating Story Intelligenceâ„¢ branding..."
          
          # Ensure Story Intelligenceâ„¢ is used consistently
          STORY_INTELLIGENCE_COUNT=$(grep -r "Story Intelligenceâ„¢" --include="*.md" . | wc -l)
          
          if [ "$STORY_INTELLIGENCE_COUNT" -lt 10 ]; then
            echo "âš ï¸  WARNING: Only $STORY_INTELLIGENCE_COUNT instances of 'Story Intelligenceâ„¢' found"
            echo "ğŸ’¡ Consider using 'Story Intelligenceâ„¢' more prominently in documentation"
          else
            echo "âœ… Story Intelligenceâ„¢ branding used $STORY_INTELLIGENCE_COUNT times"
          fi
          
      - name: ğŸ­ Validate personality enforcement middleware
        run: |
          echo "ğŸ” Checking personality enforcement implementation..."
          
          if [ ! -f "packages/universal-agent/src/middleware/PersonalityEnforcement.ts" ]; then
            echo "âŒ MISSING: PersonalityEnforcement middleware not found"
            exit 1
          fi
          
          # Check if middleware is imported in main router
          if ! grep -r "PersonalityEnforcement" packages/universal-agent/src/ >/dev/null 2>&1; then
            echo "âš ï¸  WARNING: PersonalityEnforcement middleware not imported in router"
          fi
          
          echo "âœ… Personality enforcement middleware exists"
          
      - name: ğŸ“Š Generate personality compliance report
        run: |
          echo "ğŸ“Š PERSONALITY COMPLIANCE SUMMARY"
          echo "=================================="
          echo "âœ… No forbidden AI terminology"
          echo "âœ… No business jargon violations"  
          echo "âœ… Story Intelligenceâ„¢ branding consistent"
          echo "âœ… Personality enforcement middleware present"
          echo ""
          echo "ğŸ¯ Brand compliance: PASSED"
          echo "ğŸ­ Personality guidelines: ENFORCED"
          echo "ğŸŒŸ Ready for Story Intelligenceâ„¢ powered deployment!"
          
  validate-code-personality:
    name: ğŸ” Code Personality Validation
    runs-on: ubuntu-latest
    needs: validate-personality
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run personality validation tests
        run: |
          # Create and run personality validation test
          cat > test-personality.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          // Test personality enforcement middleware
          try {
            const middleware = require('./packages/universal-agent/src/middleware/PersonalityEnforcement.ts');
            console.log('âœ… PersonalityEnforcement middleware loads correctly');
          } catch (error) {
            console.log('âš ï¸  PersonalityEnforcement middleware test skipped (TypeScript)');
          }
          
          // Test for forbidden terms in TypeScript files
          const glob = require('glob');
          const forbiddenTerms = ['AI-powered', 'AI-driven', 'personalized'];
          let violations = 0;
          
          glob.sync('packages/**/*.ts').forEach(file => {
            const content = fs.readFileSync(file, 'utf8');
            forbiddenTerms.forEach(term => {
              if (content.includes(term)) {
                console.log(`âŒ Found "${term}" in ${file}`);
                violations++;
              }
            });
          });
          
          if (violations === 0) {
            console.log('âœ… No personality violations in TypeScript code');
          } else {
            console.log(`âŒ Found ${violations} personality violations`);
            process.exit(1);
          }
          EOF
          
          node test-personality.js
          
      - name: ğŸ‰ Personality validation success
        run: |
          echo "ğŸ‰ PERSONALITY VALIDATION COMPLETE"
          echo "================================="
          echo "âœ… All Story Intelligenceâ„¢ branding validated"
          echo "âœ… No forbidden terminology detected" 
          echo "âœ… Code personality compliance verified"
          echo ""
          echo "ğŸŒŸ Your codebase is ready for Story Intelligenceâ„¢ powered deployment!"