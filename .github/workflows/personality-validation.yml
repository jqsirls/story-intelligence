name: üé≠ Personality Validation
on: 
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'supabase/migrations/**'
      - 'supabase/schema.sql'
      - 'supabase/config.toml'
      - 'supabase/.env'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'supabase/migrations/**'
      - 'supabase/schema.sql'
      - 'supabase/config.toml'
      - 'supabase/.env'

jobs:
  validate-personality:
    name: üéØ Story Intelligence‚Ñ¢ Brand Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üßæ Determine changed files
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA=""
          HEAD_SHA="${{ github.sha }}"
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi
          
          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"
          
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" > changed_files.txt || true
          
          echo "Changed files:"
          cat changed_files.txt || true
        
      - name: üö® Check for forbidden AI terminology
        shell: bash
        run: |
          set -euo pipefail
          echo "üîç Scanning changed files for forbidden terminology..."
          
          FILES="$(grep -E '\\.(ts|js|md)$' changed_files.txt || true)"
          if [[ -z "$FILES" ]]; then
            echo "‚úÖ No changed .ts/.js/.md files to scan"
            exit 0
          fi
          
          # Check for AI-powered and variations
          if grep -n -E "AI-powered|AI-driven|AI-led" $FILES; then
            echo "‚ùå VIOLATION: Forbidden AI terminology found in changed files"
            echo "üí° Use 'Story Intelligence‚Ñ¢ powered' instead of 'AI-powered'"
            echo "üí° Use 'Story Intelligence‚Ñ¢ enhanced' instead of 'AI-driven'"
            exit 1
          fi
          
          # Check for personalized (should be age-appropriate)
          if grep -n -E "personalized" $FILES; then
            echo "‚ùå VIOLATION: 'personalized' found - use 'age-appropriate' instead"
            exit 1
          fi
          
          # Check for business jargon (code files)
          CODE_FILES="$(grep -E '\\.(ts|js)$' changed_files.txt || true)"
          if [[ -n "$CODE_FILES" ]]; then
            if grep -n -E "optimize|leverage|utilize|solutioning" $CODE_FILES; then
              echo "‚ùå VIOLATION: Business jargon found - use simple, clear language"
              exit 1
            fi
          fi
          
          echo "‚úÖ No forbidden terminology found in changed files"
          
      - name: üìè Validate sentence length in key files
        shell: bash
        run: |
          set -euo pipefail
          echo "üîç Checking sentence length in changed README files..."
          
          README_FILES="$(grep -E 'README\\.md$' changed_files.txt || true)"
          if [[ -z "$README_FILES" ]]; then
            echo "‚úÖ No changed README.md files to scan"
            exit 0
          fi
          
          for f in $README_FILES; do
            awk '
              /^[^#]/ {
                gsub(/[.!?]+/, ".|", $0);
                split($0, sentences, "|");
                for (i in sentences) {
                  if (gsub(/ /, " ", sentences[i]) > 18) {
                    print FILENAME ":" NR ": Sentence too long (" gsub(/ /, " ", sentences[i]) " words): " sentences[i];
                    exit 1;
                  }
                }
              }' "$f"
          done
          
          echo "‚úÖ Sentence length validation passed"
          
      - name: üéØ Check Story Intelligence‚Ñ¢ branding consistency
        run: |
          echo "üîç Validating Story Intelligence‚Ñ¢ branding..."
          
          # Ensure Story Intelligence‚Ñ¢ is used consistently
          STORY_INTELLIGENCE_COUNT=$(grep -r "Story Intelligence‚Ñ¢" --include="*.md" . | wc -l)
          
          if [ "$STORY_INTELLIGENCE_COUNT" -lt 10 ]; then
            echo "‚ö†Ô∏è  WARNING: Only $STORY_INTELLIGENCE_COUNT instances of 'Story Intelligence‚Ñ¢' found"
            echo "üí° Consider using 'Story Intelligence‚Ñ¢' more prominently in documentation"
          else
            echo "‚úÖ Story Intelligence‚Ñ¢ branding used $STORY_INTELLIGENCE_COUNT times"
          fi
          
      - name: üé≠ Validate personality enforcement middleware
        run: |
          echo "üîç Checking personality enforcement implementation..."
          
          if [ ! -f "packages/universal-agent/src/middleware/PersonalityEnforcement.ts" ]; then
            echo "‚ùå MISSING: PersonalityEnforcement middleware not found"
            exit 1
          fi
          
          # Check if middleware is imported in main router
          if ! grep -r "PersonalityEnforcement" packages/universal-agent/src/ >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  WARNING: PersonalityEnforcement middleware not imported in router"
          fi
          
          echo "‚úÖ Personality enforcement middleware exists"
          
      - name: üìä Generate personality compliance report
        run: |
          echo "üìä PERSONALITY COMPLIANCE SUMMARY"
          echo "=================================="
          echo "‚úÖ No forbidden AI terminology"
          echo "‚úÖ No business jargon violations"  
          echo "‚úÖ Story Intelligence‚Ñ¢ branding consistent"
          echo "‚úÖ Personality enforcement middleware present"
          echo ""
          echo "üéØ Brand compliance: PASSED"
          echo "üé≠ Personality guidelines: ENFORCED"
          echo "üåü Ready for Story Intelligence‚Ñ¢ powered deployment!"
          
  validate-code-personality:
    name: üîç Code Personality Validation
    runs-on: ubuntu-latest
    needs: validate-personality
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          corepack enable
          corepack prepare pnpm@9.15.4 --activate
          pnpm install --no-frozen-lockfile
          
      - name: üßæ Determine changed files
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA=""
          HEAD_SHA="${{ github.sha }}"
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi
          
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" > changed_files.txt || true
        
      - name: üß™ Run personality validation tests
        run: |
          # Create and run personality validation test
          cat > test-personality.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          // Test personality enforcement middleware
          try {
            const middleware = require('./packages/universal-agent/src/middleware/PersonalityEnforcement.ts');
            console.log('‚úÖ PersonalityEnforcement middleware loads correctly');
          } catch (error) {
            console.log('‚ö†Ô∏è  PersonalityEnforcement middleware test skipped (TypeScript)');
          }
          
          // Test for forbidden terms in CHANGED TypeScript files
          const changed = fs.readFileSync('changed_files.txt', 'utf8')
            .split('\\n')
            .map(s => s.trim())
            .filter(Boolean)
            .filter(f => f.endsWith('.ts'));
          
          const forbiddenTerms = ['AI-powered', 'AI-driven', 'personalized'];
          let violations = 0;
          
          for (const file of changed) {
            if (!fs.existsSync(file)) continue;
            const content = fs.readFileSync(file, 'utf8');
            for (const term of forbiddenTerms) {
              if (content.includes(term)) {
                console.log(`‚ùå Found "${term}" in ${file}`);
                violations++;
              }
            }
          }
          
          if (violations === 0) {
            console.log('‚úÖ No personality violations in TypeScript code');
          } else {
            console.log(`‚ùå Found ${violations} personality violations`);
            process.exit(1);
          }
          EOF
          
          node test-personality.js
          
      - name: üéâ Personality validation success
        run: |
          echo "üéâ PERSONALITY VALIDATION COMPLETE"
          echo "================================="
          echo "‚úÖ All Story Intelligence‚Ñ¢ branding validated"
          echo "‚úÖ No forbidden terminology detected" 
          echo "‚úÖ Code personality compliance verified"
          echo ""
          echo "üåü Your codebase is ready for Story Intelligence‚Ñ¢ powered deployment!"