#!/usr/bin/env python3\n\"\"\"\nCOPPA/GDPR Compliance Validation Tests for Storytailor Multi-Agent System\nComprehensive testing for privacy compliance requirements\n\"\"\"\n\nimport os\nimport sys\nimport json\nimport requests\nimport time\nfrom datetime import datetime, timedelta\nfrom typing import Dict, List, Optional, Any\nfrom dataclasses import dataclass\nimport logging\nimport uuid\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(levelname)s - %(message)s',\n    handlers=[\n        logging.FileHandler('compliance_test_results.log'),\n        logging.StreamHandler(sys.stdout)\n    ]\n)\nlogger = logging.getLogger(__name__)\n\n@dataclass\nclass ComplianceTestResult:\n    test_name: str\n    regulation: str  # COPPA, GDPR, UK_CHILDRENS_CODE\n    status: str  # PASS, FAIL, WARNING\n    details: str\n    severity: str  # CRITICAL, HIGH, MEDIUM, LOW\n    requirement: str  # Specific regulation requirement\n    remediation: Optional[str] = None\n\nclass ComplianceValidator:\n    def __init__(self, api_base_url: str, api_key: str):\n        self.api_base_url = api_base_url.rstrip('/')\n        self.api_key = api_key\n        self.session = requests.Session()\n        self.session.headers.update({\n            'Authorization': f'Bearer {api_key}',\n            'Content-Type': 'application/json'\n        })\n        self.results: List[ComplianceTestResult] = []\n        \n    def add_result(self, test_name: str, regulation: str, status: str, \n                   details: str, severity: str, requirement: str, \n                   remediation: Optional[str] = None):\n        \"\"\"Add a compliance test result\"\"\"\n        result = ComplianceTestResult(\n            test_name=test_name,\n            regulation=regulation,\n            status=status,\n            details=details,\n            severity=severity,\n            requirement=requirement,\n            remediation=remediation\n        )\n        self.results.append(result)\n        logger.info(f\"{regulation} - {test_name}: {status} - {details}\")\n    \n    def test_coppa_parental_consent(self):\n        \"\"\"Test COPPA parental consent requirements\"\"\"\n        logger.info(\"Testing COPPA parental consent requirements...\")\n        \n        # Test 1: Under-13 user without parental consent\n        try:\n            payload = {\n                'platform': 'api',\n                'user': {\n                    'email': 'child@example.com',\n                    'age': 10,\n                    'parentalConsent': False\n                }\n            }\n            response = self.session.post(f\"{self.api_base_url}/v1/conversation/start\", json=payload)\n            \n            if response.status_code == 200:\n                self.add_result(\n                    \"Under-13 Without Consent\",\n                    \"COPPA\",\n                    \"FAIL\",\n                    \"System allows under-13 users without parental consent\",\n                    \"CRITICAL\",\n                    \"15 U.S.C. §6502(b)(1)(A)(ii) - Parental consent required\",\n                    \"Implement parental consent verification before allowing under-13 users\"\n                )\n            else:\n                self.add_result(\n                    \"Under-13 Without Consent\",\n                    \"COPPA\",\n                    \"PASS\",\n                    \"System properly blocks under-13 users without parental consent\",\n                    \"LOW\",\n                    \"15 U.S.C. §6502(b)(1)(A)(ii)\"\n                )\n        except Exception as e:\n            self.add_result(\n                \"Under-13 Without Consent\",\n                \"COPPA\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"15 U.S.C. §6502(b)(1)(A)(ii)\"\n            )\n        \n        # Test 2: Parental consent verification process\n        try:\n            payload = {\n                'parentEmail': 'parent@example.com',\n                'childAge': 8,\n                'consentType': 'email_plus_additional'\n            }\n            response = self.session.post(f\"{self.api_base_url}/v1/auth/parental-consent\", json=payload)\n            \n            if response.status_code == 404:\n                self.add_result(\n                    \"Parental Consent Process\",\n                    \"COPPA\",\n                    \"FAIL\",\n                    \"No parental consent verification endpoint available\",\n                    \"CRITICAL\",\n                    \"15 U.S.C. §6502(b)(1)(A)(ii) - Verifiable parental consent\",\n                    \"Implement parental consent verification system\"\n                )\n            elif response.status_code in [200, 201]:\n                # Check if proper verification methods are supported\n                response_data = response.json()\n                verification_methods = response_data.get('verificationMethods', [])\n                \n                required_methods = ['email_verification', 'sms_verification', 'id_verification']\n                if not any(method in verification_methods for method in required_methods):\n                    self.add_result(\n                        \"Parental Consent Verification Methods\",\n                        \"COPPA\",\n                        \"FAIL\",\n                        \"Insufficient parental verification methods available\",\n                        \"HIGH\",\n                        \"16 CFR §312.5(b) - Reasonable efforts to verify parent identity\",\n                        \"Implement multiple verification methods (email+SMS, ID verification)\"\n                    )\n                else:\n                    self.add_result(\n                        \"Parental Consent Verification Methods\",\n                        \"COPPA\",\n                        \"PASS\",\n                        \"Adequate parental verification methods available\",\n                        \"LOW\",\n                        \"16 CFR §312.5(b)\"\n                    )\n        except Exception as e:\n            self.add_result(\n                \"Parental Consent Process\",\n                \"COPPA\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"15 U.S.C. §6502(b)(1)(A)(ii)\"\n            )\n    \n    def test_coppa_data_collection_limits(self):\n        \"\"\"Test COPPA data collection limitations\"\"\"\n        logger.info(\"Testing COPPA data collection limits...\")\n        \n        # Test 1: Excessive data collection from children\n        try:\n            payload = {\n                'platform': 'api',\n                'user': {\n                    'email': 'child@example.com',\n                    'age': 9,\n                    'fullName': 'Child Name',\n                    'address': '123 Main St, City, State 12345',\n                    'phoneNumber': '555-123-4567',\n                    'schoolName': 'Elementary School',\n                    'parentalConsent': True\n                }\n            }\n            response = self.session.post(f\"{self.api_base_url}/v1/conversation/start\", json=payload)\n            \n            # Check if system accepts excessive personal information\n            if response.status_code == 200:\n                response_data = response.json()\n                stored_data = response_data.get('userProfile', {})\n                \n                excessive_fields = ['address', 'phoneNumber', 'schoolName']\n                collected_excessive = [field for field in excessive_fields if field in stored_data]\n                \n                if collected_excessive:\n                    self.add_result(\n                        \"Excessive Data Collection\",\n                        \"COPPA\",\n                        \"FAIL\",\n                        f\"System collects excessive data from children: {collected_excessive}\",\n                        \"HIGH\",\n                        \"15 U.S.C. §6501(8) - Only necessary information\",\n                        \"Limit data collection to only what's necessary for service operation\"\n                    )\n                else:\n                    self.add_result(\n                        \"Data Collection Minimization\",\n                        \"COPPA\",\n                        \"PASS\",\n                        \"System follows data minimization principles\",\n                        \"LOW\",\n                        \"15 U.S.C. §6501(8)\"\n                    )\n        except Exception as e:\n            self.add_result(\n                \"Data Collection Limits\",\n                \"COPPA\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"15 U.S.C. §6501(8)\"\n            )\n        \n        # Test 2: Data retention periods for children\n        try:\n            # Check if there's a data retention policy endpoint\n            response = self.session.get(f\"{self.api_base_url}/v1/privacy/retention-policy\")\n            \n            if response.status_code == 200:\n                policy = response.json()\n                child_retention = policy.get('childDataRetention', {})\n                \n                # COPPA requires deletion when no longer necessary\n                if not child_retention.get('automaticDeletion'):\n                    self.add_result(\n                        \"Child Data Retention\",\n                        \"COPPA\",\n                        \"FAIL\",\n                        \"No automatic deletion policy for child data\",\n                        \"HIGH\",\n                        \"16 CFR §312.10 - Delete when no longer necessary\",\n                        \"Implement automatic deletion of child data when no longer necessary\"\n                    )\n                else:\n                    retention_period = child_retention.get('retentionDays', 0)\n                    if retention_period > 365:  # More than 1 year is excessive\n                        self.add_result(\n                            \"Child Data Retention Period\",\n                            \"COPPA\",\n                            \"WARNING\",\n                            f\"Child data retention period is {retention_period} days\",\n                            \"MEDIUM\",\n                            \"16 CFR §312.10\",\n                            \"Consider shorter retention periods for child data\"\n                        )\n                    else:\n                        self.add_result(\n                            \"Child Data Retention\",\n                            \"COPPA\",\n                            \"PASS\",\n                            f\"Appropriate child data retention period: {retention_period} days\",\n                            \"LOW\",\n                            \"16 CFR §312.10\"\n                        )\n            else:\n                self.add_result(\n                    \"Data Retention Policy\",\n                    \"COPPA\",\n                    \"FAIL\",\n                    \"No data retention policy available\",\n                    \"HIGH\",\n                    \"16 CFR §312.10\",\n                    \"Implement and publish data retention policy\"\n                )\n        except Exception as e:\n            self.add_result(\n                \"Data Retention Policy\",\n                \"COPPA\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"16 CFR §312.10\"\n            )\n    \n    def test_gdpr_data_subject_rights(self):\n        \"\"\"Test GDPR data subject rights implementation\"\"\"\n        logger.info(\"Testing GDPR data subject rights...\")\n        \n        # Test 1: Right to access (Article 15)\n        try:\n            response = self.session.get(f\"{self.api_base_url}/v1/user/data-export\")\n            \n            if response.status_code == 404:\n                self.add_result(\n                    \"Right to Access\",\n                    \"GDPR\",\n                    \"FAIL\",\n                    \"No data export endpoint available\",\n                    \"CRITICAL\",\n                    \"GDPR Article 15 - Right of access\",\n                    \"Implement data export functionality for users\"\n                )\n            elif response.status_code == 200:\n                # Check if export includes required information\n                export_data = response.json()\n                required_fields = ['personalData', 'processingPurposes', 'dataRetention', 'thirdParties']\n                missing_fields = [field for field in required_fields if field not in export_data]\n                \n                if missing_fields:\n                    self.add_result(\n                        \"Data Export Completeness\",\n                        \"GDPR\",\n                        \"FAIL\",\n                        f\"Data export missing required information: {missing_fields}\",\n                        \"HIGH\",\n                        \"GDPR Article 15(1) - Complete information\",\n                        \"Include all required information in data exports\"\n                    )\n                else:\n                    self.add_result(\n                        \"Right to Access\",\n                        \"GDPR\",\n                        \"PASS\",\n                        \"Complete data export functionality available\",\n                        \"LOW\",\n                        \"GDPR Article 15\"\n                    )\n        except Exception as e:\n            self.add_result(\n                \"Right to Access\",\n                \"GDPR\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"GDPR Article 15\"\n            )\n        \n        # Test 2: Right to erasure (Article 17)\n        try:\n            response = self.session.delete(f\"{self.api_base_url}/v1/user/delete-account\")\n            \n            if response.status_code == 404:\n                self.add_result(\n                    \"Right to Erasure\",\n                    \"GDPR\",\n                    \"FAIL\",\n                    \"No account deletion endpoint available\",\n                    \"CRITICAL\",\n                    \"GDPR Article 17 - Right to erasure\",\n                    \"Implement account deletion functionality\"\n                )\n            elif response.status_code in [200, 202]:\n                deletion_info = response.json()\n                \n                # Check if deletion is immediate or scheduled\n                if deletion_info.get('deletionScheduled'):\n                    deletion_time = deletion_info.get('scheduledDeletionTime')\n                    if deletion_time:\n                        # Parse deletion time and check if it's within reasonable timeframe\n                        try:\n                            deletion_date = datetime.fromisoformat(deletion_time.replace('Z', '+00:00'))\n                            days_until_deletion = (deletion_date - datetime.now()).days\n                            \n                            if days_until_deletion > 30:\n                                self.add_result(\n                                    \"Deletion Timeframe\",\n                                    \"GDPR\",\n                                    \"WARNING\",\n                                    f\"Account deletion scheduled for {days_until_deletion} days\",\n                                    \"MEDIUM\",\n                                    \"GDPR Article 17 - Without undue delay\",\n                                    \"Consider faster deletion timeframes\"\n                                )\n                            else:\n                                self.add_result(\n                                    \"Right to Erasure\",\n                                    \"GDPR\",\n                                    \"PASS\",\n                                    f\"Account deletion scheduled within {days_until_deletion} days\",\n                                    \"LOW\",\n                                    \"GDPR Article 17\"\n                                )\n                        except ValueError:\n                            self.add_result(\n                                \"Deletion Scheduling\",\n                                \"GDPR\",\n                                \"WARNING\",\n                                \"Invalid deletion schedule format\",\n                                \"MEDIUM\",\n                                \"GDPR Article 17\"\n                            )\n                else:\n                    self.add_result(\n                        \"Right to Erasure\",\n                        \"GDPR\",\n                        \"PASS\",\n                        \"Immediate account deletion available\",\n                        \"LOW\",\n                        \"GDPR Article 17\"\n                    )\n        except Exception as e:\n            self.add_result(\n                \"Right to Erasure\",\n                \"GDPR\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"GDPR Article 17\"\n            )\n        \n        # Test 3: Right to rectification (Article 16)\n        try:\n            payload = {\n                'updates': {\n                    'email': 'newemail@example.com',\n                    'preferences': {'theme': 'dark'}\n                }\n            }\n            response = self.session.put(f\"{self.api_base_url}/v1/user/profile\", json=payload)\n            \n            if response.status_code == 404:\n                self.add_result(\n                    \"Right to Rectification\",\n                    \"GDPR\",\n                    \"FAIL\",\n                    \"No profile update endpoint available\",\n                    \"HIGH\",\n                    \"GDPR Article 16 - Right to rectification\",\n                    \"Implement profile update functionality\"\n                )\n            elif response.status_code == 200:\n                self.add_result(\n                    \"Right to Rectification\",\n                    \"GDPR\",\n                    \"PASS\",\n                    \"Profile update functionality available\",\n                    \"LOW\",\n                    \"GDPR Article 16\"\n                )\n        except Exception as e:\n            self.add_result(\n                \"Right to Rectification\",\n                \"GDPR\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"GDPR Article 16\"\n            )\n    \n    def test_gdpr_consent_management(self):\n        \"\"\"Test GDPR consent management requirements\"\"\"\n        logger.info(\"Testing GDPR consent management...\")\n        \n        # Test 1: Granular consent management\n        try:\n            response = self.session.get(f\"{self.api_base_url}/v1/user/consent\")\n            \n            if response.status_code == 404:\n                self.add_result(\n                    \"Consent Management\",\n                    \"GDPR\",\n                    \"FAIL\",\n                    \"No consent management endpoint available\",\n                    \"CRITICAL\",\n                    \"GDPR Article 7 - Consent management\",\n                    \"Implement granular consent management system\"\n                )\n            elif response.status_code == 200:\n                consent_data = response.json()\n                consent_purposes = consent_data.get('purposes', {})\n                \n                # Check for granular consent purposes\n                expected_purposes = ['story_creation', 'voice_processing', 'analytics', 'marketing']\n                available_purposes = list(consent_purposes.keys())\n                \n                if len(available_purposes) < 2:\n                    self.add_result(\n                        \"Granular Consent\",\n                        \"GDPR\",\n                        \"FAIL\",\n                        \"Consent management lacks granularity\",\n                        \"HIGH\",\n                        \"GDPR Article 7(4) - Granular consent\",\n                        \"Implement separate consent for different processing purposes\"\n                    )\n                else:\n                    self.add_result(\n                        \"Granular Consent\",\n                        \"GDPR\",\n                        \"PASS\",\n                        f\"Granular consent available for {len(available_purposes)} purposes\",\n                        \"LOW\",\n                        \"GDPR Article 7\"\n                    )\n                \n                # Check if consent can be withdrawn\n                if not consent_data.get('withdrawalAvailable'):\n                    self.add_result(\n                        \"Consent Withdrawal\",\n                        \"GDPR\",\n                        \"FAIL\",\n                        \"No consent withdrawal mechanism available\",\n                        \"CRITICAL\",\n                        \"GDPR Article 7(3) - Right to withdraw consent\",\n                        \"Implement consent withdrawal functionality\"\n                    )\n                else:\n                    self.add_result(\n                        \"Consent Withdrawal\",\n                        \"GDPR\",\n                        \"PASS\",\n                        \"Consent withdrawal mechanism available\",\n                        \"LOW\",\n                        \"GDPR Article 7(3)\"\n                    )\n        except Exception as e:\n            self.add_result(\n                \"Consent Management\",\n                \"GDPR\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"GDPR Article 7\"\n            )\n        \n        # Test 2: Consent withdrawal processing\n        try:\n            payload = {\n                'purpose': 'analytics',\n                'action': 'withdraw'\n            }\n            response = self.session.post(f\"{self.api_base_url}/v1/user/consent/withdraw\", json=payload)\n            \n            if response.status_code in [200, 202]:\n                withdrawal_info = response.json()\n                \n                # Check if data processing stops immediately\n                if not withdrawal_info.get('immediateStop'):\n                    self.add_result(\n                        \"Consent Withdrawal Processing\",\n                        \"GDPR\",\n                        \"WARNING\",\n                        \"Data processing may not stop immediately upon consent withdrawal\",\n                        \"MEDIUM\",\n                        \"GDPR Article 7(3) - Immediate effect\",\n                        \"Ensure data processing stops immediately upon consent withdrawal\"\n                    )\n                else:\n                    self.add_result(\n                        \"Consent Withdrawal Processing\",\n                        \"GDPR\",\n                        \"PASS\",\n                        \"Data processing stops immediately upon consent withdrawal\",\n                        \"LOW\",\n                        \"GDPR Article 7(3)\"\n                    )\n        except Exception as e:\n            self.add_result(\n                \"Consent Withdrawal Processing\",\n                \"GDPR\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"GDPR Article 7(3)\"\n            )\n    \n    def test_uk_childrens_code_compliance(self):\n        \"\"\"Test UK Children's Code compliance\"\"\"\n        logger.info(\"Testing UK Children's Code compliance...\")\n        \n        # Test 1: Privacy by design and default\n        try:\n            # Check default privacy settings for new child accounts\n            payload = {\n                'platform': 'api',\n                'user': {\n                    'email': 'child@example.com',\n                    'age': 10,\n                    'parentalConsent': True\n                }\n            }\n            response = self.session.post(f\"{self.api_base_url}/v1/conversation/start\", json=payload)\n            \n            if response.status_code == 200:\n                session_data = response.json()\n                privacy_settings = session_data.get('privacySettings', {})\n                \n                # Check if most privacy-protective settings are default\n                expected_defaults = {\n                    'dataSharing': False,\n                    'analytics': False,\n                    'marketing': False,\n                    'locationTracking': False\n                }\n                \n                non_compliant_defaults = []\n                for setting, expected_value in expected_defaults.items():\n                    if privacy_settings.get(setting) != expected_value:\n                        non_compliant_defaults.append(setting)\n                \n                if non_compliant_defaults:\n                    self.add_result(\n                        \"Privacy by Default\",\n                        \"UK_CHILDRENS_CODE\",\n                        \"FAIL\",\n                        f\"Non-privacy-protective defaults: {non_compliant_defaults}\",\n                        \"HIGH\",\n                        \"UK Children's Code Standard 1 - Privacy by design and default\",\n                        \"Set most privacy-protective settings as default for children\"\n                    )\n                else:\n                    self.add_result(\n                        \"Privacy by Default\",\n                        \"UK_CHILDRENS_CODE\",\n                        \"PASS\",\n                        \"Privacy-protective settings are default for children\",\n                        \"LOW\",\n                        \"UK Children's Code Standard 1\"\n                    )\n        except Exception as e:\n            self.add_result(\n                \"Privacy by Default\",\n                \"UK_CHILDRENS_CODE\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"UK Children's Code Standard 1\"\n            )\n        \n        # Test 2: Age-appropriate application\n        try:\n            # Test different age groups get appropriate interfaces\n            age_groups = [5, 8, 12, 15]\n            \n            for age in age_groups:\n                payload = {\n                    'platform': 'api',\n                    'user': {\n                        'email': f'child{age}@example.com',\n                        'age': age,\n                        'parentalConsent': True if age < 13 else False\n                    }\n                }\n                response = self.session.post(f\"{self.api_base_url}/v1/conversation/start\", json=payload)\n                \n                if response.status_code == 200:\n                    session_data = response.json()\n                    interface_config = session_data.get('interfaceConfig', {})\n                    \n                    # Check age-appropriate interface elements\n                    if age <= 6:\n                        # Very young children need visual/audio interfaces\n                        if not interface_config.get('visualInterface') or not interface_config.get('audioInterface'):\n                            self.add_result(\n                                f\"Age-Appropriate Interface (Age {age})\",\n                                \"UK_CHILDRENS_CODE\",\n                                \"FAIL\",\n                                \"Interface not appropriate for very young children\",\n                                \"MEDIUM\",\n                                \"UK Children's Code Standard 2 - Age-appropriate application\",\n                                \"Provide visual and audio interfaces for very young children\"\n                            )\n                    elif age <= 11:\n                        # School-age children need simplified interfaces\n                        if interface_config.get('complexityLevel', 'standard') != 'simplified':\n                            self.add_result(\n                                f\"Age-Appropriate Interface (Age {age})\",\n                                \"UK_CHILDRENS_CODE\",\n                                \"WARNING\",\n                                \"Interface may be too complex for school-age children\",\n                                \"MEDIUM\",\n                                \"UK Children's Code Standard 2\",\n                                \"Simplify interface for school-age children\"\n                            )\n            \n            self.add_result(\n                \"Age-Appropriate Application\",\n                \"UK_CHILDRENS_CODE\",\n                \"PASS\",\n                \"Age-appropriate interfaces implemented\",\n                \"LOW\",\n                \"UK Children's Code Standard 2\"\n            )\n        except Exception as e:\n            self.add_result(\n                \"Age-Appropriate Application\",\n                \"UK_CHILDRENS_CODE\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"UK Children's Code Standard 2\"\n            )\n        \n        # Test 3: Data minimization\n        try:\n            # Check if system only collects necessary data\n            payload = {\n                'platform': 'api',\n                'user': {\n                    'email': 'child@example.com',\n                    'age': 10,\n                    'fullName': 'Child Name',\n                    'address': '123 Main St',\n                    'phoneNumber': '555-1234',\n                    'favoriteColor': 'blue',\n                    'parentalConsent': True\n                }\n            }\n            response = self.session.post(f\"{self.api_base_url}/v1/conversation/start\", json=payload)\n            \n            if response.status_code == 200:\n                session_data = response.json()\n                collected_data = session_data.get('userProfile', {})\n                \n                # Check what data was actually stored\n                unnecessary_fields = ['address', 'phoneNumber']\n                collected_unnecessary = [field for field in unnecessary_fields if field in collected_data]\n                \n                if collected_unnecessary:\n                    self.add_result(\n                        \"Data Minimization\",\n                        \"UK_CHILDRENS_CODE\",\n                        \"FAIL\",\n                        f\"System collects unnecessary data: {collected_unnecessary}\",\n                        \"HIGH\",\n                        \"UK Children's Code Standard 3 - Data minimization\",\n                        \"Only collect data that is necessary for the service to function\"\n                    )\n                else:\n                    self.add_result(\n                        \"Data Minimization\",\n                        \"UK_CHILDRENS_CODE\",\n                        \"PASS\",\n                        \"System follows data minimization principles\",\n                        \"LOW\",\n                        \"UK Children's Code Standard 3\"\n                    )\n        except Exception as e:\n            self.add_result(\n                \"Data Minimization\",\n                \"UK_CHILDRENS_CODE\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"UK Children's Code Standard 3\"\n            )\n    \n    def test_data_breach_notification(self):\n        \"\"\"Test data breach notification procedures\"\"\"\n        logger.info(\"Testing data breach notification procedures...\")\n        \n        # Test 1: Check if breach notification endpoint exists\n        try:\n            response = self.session.get(f\"{self.api_base_url}/v1/admin/breach-procedures\")\n            \n            if response.status_code == 404:\n                self.add_result(\n                    \"Breach Notification Procedures\",\n                    \"GDPR\",\n                    \"FAIL\",\n                    \"No breach notification procedures documented\",\n                    \"HIGH\",\n                    \"GDPR Article 33/34 - Breach notification\",\n                    \"Document and implement breach notification procedures\"\n                )\n            elif response.status_code == 200:\n                procedures = response.json()\n                \n                # Check if 72-hour notification is mentioned\n                if '72' not in str(procedures) and 'hour' not in str(procedures):\n                    self.add_result(\n                        \"72-Hour Notification\",\n                        \"GDPR\",\n                        \"WARNING\",\n                        \"72-hour notification requirement not clearly documented\",\n                        \"MEDIUM\",\n                        \"GDPR Article 33(1) - 72-hour notification\",\n                        \"Clearly document 72-hour breach notification requirement\"\n                    )\n                else:\n                    self.add_result(\n                        \"Breach Notification Procedures\",\n                        \"GDPR\",\n                        \"PASS\",\n                        \"Breach notification procedures documented\",\n                        \"LOW\",\n                        \"GDPR Article 33/34\"\n                    )\n        except Exception as e:\n            self.add_result(\n                \"Breach Notification Procedures\",\n                \"GDPR\",\n                \"WARNING\",\n                f\"Test failed with error: {e}\",\n                \"MEDIUM\",\n                \"GDPR Article 33/34\"\n            )\n    \n    def generate_compliance_report(self) -> Dict[str, Any]:\n        \"\"\"Generate comprehensive compliance report\"\"\"\n        logger.info(\"Generating compliance report...\")\n        \n        # Group results by regulation\n        regulation_results = {\n            'COPPA': [],\n            'GDPR': [],\n            'UK_CHILDRENS_CODE': []\n        }\n        \n        severity_counts = {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}\n        status_counts = {'PASS': 0, 'FAIL': 0, 'WARNING': 0}\n        \n        for result in self.results:\n            regulation_results[result.regulation].append(result)\n            severity_counts[result.severity] += 1\n            status_counts[result.status] += 1\n        \n        # Calculate compliance scores\n        total_tests = len(self.results)\n        overall_score = (status_counts['PASS'] / total_tests * 100) if total_tests > 0 else 0\n        \n        compliance_status = {\n            'COPPA': 'COMPLIANT' if severity_counts['CRITICAL'] == 0 and \n                     len([r for r in self.results if r.regulation == 'COPPA' and r.status == 'FAIL']) == 0 else 'NON_COMPLIANT',\n            'GDPR': 'COMPLIANT' if severity_counts['CRITICAL'] == 0 and \n                    len([r for r in self.results if r.regulation == 'GDPR' and r.status == 'FAIL']) == 0 else 'NON_COMPLIANT',\n            'UK_CHILDRENS_CODE': 'COMPLIANT' if severity_counts['CRITICAL'] == 0 and \n                                 len([r for r in self.results if r.regulation == 'UK_CHILDRENS_CODE' and r.status == 'FAIL']) == 0 else 'NON_COMPLIANT'\n        }\n        \n        # Generate recommendations\n        critical_issues = [r for r in self.results if r.severity == 'CRITICAL']\n        high_issues = [r for r in self.results if r.severity == 'HIGH']\n        \n        recommendations = []\n        if critical_issues:\n            recommendations.append({\n                'priority': 'IMMEDIATE',\n                'description': f'Address {len(critical_issues)} critical compliance issues immediately',\n                'issues': [{'test': r.test_name, 'regulation': r.regulation, 'remediation': r.remediation} for r in critical_issues]\n            })\n        \n        if high_issues:\n            recommendations.append({\n                'priority': 'HIGH',\n                'description': f'Address {len(high_issues)} high-priority compliance issues within 30 days',\n                'issues': [{'test': r.test_name, 'regulation': r.regulation, 'remediation': r.remediation} for r in high_issues]\n            })\n        \n        report = {\n            'timestamp': datetime.now().isoformat(),\n            'api_endpoint': self.api_base_url,\n            'summary': {\n                'total_tests': total_tests,\n                'overall_compliance_score': round(overall_score, 2),\n                'status_counts': status_counts,\n                'severity_counts': severity_counts,\n                'compliance_status': compliance_status\n            },\n            'regulation_breakdown': {\n                regulation: {\n                    'total_tests': len(results),\n                    'passed': len([r for r in results if r.status == 'PASS']),\n                    'failed': len([r for r in results if r.status == 'FAIL']),\n                    'warnings': len([r for r in results if r.status == 'WARNING']),\n                    'compliance_status': compliance_status[regulation]\n                } for regulation, results in regulation_results.items()\n            },\n            'recommendations': recommendations,\n            'detailed_results': [\n                {\n                    'test_name': r.test_name,\n                    'regulation': r.regulation,\n                    'status': r.status,\n                    'details': r.details,\n                    'severity': r.severity,\n                    'requirement': r.requirement,\n                    'remediation': r.remediation\n                } for r in self.results\n            ]\n        }\n        \n        return report\n    \n    def run_all_compliance_tests(self) -> Dict[str, Any]:\n        \"\"\"Run all compliance validation tests\"\"\"\n        logger.info(\"Starting comprehensive compliance validation...\")\n        \n        # Run COPPA tests\n        self.test_coppa_parental_consent()\n        self.test_coppa_data_collection_limits()\n        \n        # Run GDPR tests\n        self.test_gdpr_data_subject_rights()\n        self.test_gdpr_consent_management()\n        \n        # Run UK Children's Code tests\n        self.test_uk_childrens_code_compliance()\n        \n        # Run general privacy tests\n        self.test_data_breach_notification()\n        \n        # Generate and return report\n        report = self.generate_compliance_report()\n        \n        logger.info(f\"Compliance validation completed. Overall score: {report['summary']['overall_compliance_score']}%\")\n        logger.info(f\"Critical issues: {report['summary']['severity_counts']['CRITICAL']}\")\n        logger.info(f\"High priority issues: {report['summary']['severity_counts']['HIGH']}\")\n        \n        return report\n\ndef main():\n    \"\"\"Main function to run compliance tests\"\"\"\n    import argparse\n    \n    parser = argparse.ArgumentParser(description='Run COPPA/GDPR compliance tests for Storytailor API')\n    parser.add_argument('--url', required=True, help='Target API URL')\n    parser.add_argument('--api-key', required=True, help='API key for authentication')\n    parser.add_argument('--output', default='compliance_report.json', help='Output report file')\n    \n    args = parser.parse_args()\n    \n    # Run compliance tests\n    validator = ComplianceValidator(args.url, args.api_key)\n    report = validator.run_all_compliance_tests()\n    \n    # Save report\n    with open(args.output, 'w') as f:\n        json.dump(report, f, indent=2)\n    \n    logger.info(f\"Compliance report saved to {args.output}\")\n    \n    # Exit with error code if critical issues found\n    if report['summary']['severity_counts']['CRITICAL'] > 0:\n        logger.error(\"Critical compliance issues detected!\")\n        sys.exit(1)\n    elif report['summary']['severity_counts']['HIGH'] > 0:\n        logger.warning(\"High priority compliance issues detected\")\n        sys.exit(2)\n    else:\n        logger.info(\"No critical or high priority compliance issues detected\")\n        sys.exit(0)\n\nif __name__ == '__main__':\n    main()"