# Storytailor Testing Suite\n\nComprehensive testing framework for the Storytailor Multi-Agent System, including load testing, security testing, compliance validation, and performance monitoring.\n\n## Overview\n\nThis testing suite ensures the Storytailor system meets all requirements:\n- **Performance**: 500 RPS capacity, <800ms response times, <150ms cold starts\n- **Security**: OWASP security standards, input validation, authentication\n- **Compliance**: COPPA, GDPR, and UK Children's Code compliance\n- **Quality**: 90%+ test coverage, integration testing\n\n## Test Categories\n\n### 1. Load Testing (`/load`)\n\n**K6 Load Tests** - Tests system performance under various load conditions\n\n```bash\n# Install K6\nbrew install k6  # macOS\n# or\nsudo apt-get install k6  # Ubuntu\n\n# Run baseline load test (500 RPS)\nk6 run --env API_BASE_URL=https://orchestrator.storytailor.com \\\n       --env API_KEY=your-api-key \\\n       --env K6_SCENARIO_NAME=baseline_load \\\n       testing/load/k6-load-tests.js\n\n# Run spike test\nk6 run --env K6_SCENARIO_NAME=spike_test testing/load/k6-load-tests.js\n\n# Run stress test\nk6 run --env K6_SCENARIO_NAME=stress_test testing/load/k6-load-tests.js\n\n# Run WebSocket test\nk6 run --env K6_SCENARIO_NAME=websocket_test testing/load/k6-load-tests.js\n```\n\n**Test Scenarios:**\n- **Baseline Load**: 500 RPS for 5 minutes (requirement validation)\n- **Spike Test**: Sudden traffic increase to 1000 RPS\n- **Stress Test**: Gradual increase to find breaking point\n- **Cold Start Test**: Lambda cold start performance\n- **WebSocket Test**: Real-time conversation testing\n\n**Performance Thresholds:**\n- 95% of requests under 800ms\n- Error rate under 1%\n- Cold starts under 150ms\n- Conversation start under 1s\n- Voice processing under 500ms\n\n### 2. Security Testing (`/security`)\n\n**OWASP ZAP Security Tests** - Comprehensive security vulnerability scanning\n\n```bash\n# Install dependencies\npip install python-owasp-zap-v2.4 requests\n\n# Start OWASP ZAP proxy (required)\n# Download from https://www.zaproxy.org/download/\n# Start ZAP with API enabled on port 8080\n\n# Run security tests\npython testing/security/owasp-zap-security-tests.py \\\n  --url https://orchestrator.storytailor.com \\\n  --api-key your-api-key \\\n  --output security_report.json\n```\n\n**Security Test Categories:**\n- **Authentication Security**: Token validation, unauthorized access\n- **Input Validation**: SQL injection, XSS, command injection\n- **Rate Limiting**: DoS protection validation\n- **Data Encryption**: HTTPS enforcement, TLS validation\n- **OWASP Top 10**: Automated vulnerability scanning\n\n**Security Requirements:**\n- No high-risk vulnerabilities\n- Proper authentication enforcement\n- Input sanitization and validation\n- Rate limiting implementation\n- Strong encryption (TLS 1.2+)\n\n### 3. Compliance Testing (`/compliance`)\n\n**COPPA/GDPR Validation Tests** - Privacy regulation compliance validation\n\n```bash\n# Install dependencies\npip install requests\n\n# Run compliance tests\npython testing/compliance/coppa-gdpr-validation-tests.py \\\n  --url https://orchestrator.storytailor.com \\\n  --api-key your-api-key \\\n  --output compliance_report.json\n```\n\n**Compliance Test Categories:**\n\n**COPPA Compliance:**\n- Parental consent verification for under-13 users\n- Data collection minimization for children\n- Child data retention policies\n- Age verification processes\n\n**GDPR Compliance:**\n- Data subject rights (access, rectification, erasure)\n- Consent management and withdrawal\n- Data export functionality\n- Breach notification procedures\n\n**UK Children's Code:**\n- Privacy by design and default\n- Age-appropriate application design\n- Data minimization principles\n- Child-friendly interfaces\n\n### 4. Performance Testing (`/performance`)\n\n**Cold Start Performance Tests** - Lambda cold start optimization validation\n\n```bash\n# Install dependencies\nnpm install aws-sdk\n\n# Configure AWS credentials\nexport AWS_REGION=us-east-1\nexport AWS_ACCESS_KEY_ID=your-access-key\nexport AWS_SECRET_ACCESS_KEY=your-secret-key\n\n# Run cold start tests\nnode testing/performance/cold-start-performance-tests.js\n\n# Or with custom configuration\nexport LAMBDA_FUNCTIONS=\"function1,function2,function3\"\nexport API_ENDPOINTS=\"https://api.example.com/endpoint1,https://api.example.com/endpoint2\"\nexport TEST_ITERATIONS=100\nexport COLD_START_THRESHOLD=150\nnode testing/performance/cold-start-performance-tests.js\n```\n\n**Performance Metrics:**\n- Cold start duration (target: <150ms)\n- Average response time\n- P95 and P99 response times\n- Success rate\n- CloudWatch metrics integration\n\n## CI/CD Integration\n\n### GitHub Actions Workflow\n\n```yaml\n# .github/workflows/testing.yml\nname: Comprehensive Testing\n\non:\n  push:\n    branches: [main, develop]\n  pull_request:\n    branches: [main]\n\njobs:\n  load-testing:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n      - name: Install K6\n        run: |\n          sudo apt-get update\n          sudo apt-get install k6\n      - name: Run Load Tests\n        run: |\n          k6 run --env API_BASE_URL=${{ secrets.API_BASE_URL }} \\\n                 --env API_KEY=${{ secrets.API_KEY }} \\\n                 testing/load/k6-load-tests.js\n\n  security-testing:\n    runs-on: ubuntu-latest\n    services:\n      zap:\n        image: owasp/zap2docker-stable\n        ports:\n          - 8080:8080\n        options: >-\n          --user root\n          --entrypoint=\"\"\n        command: >\n          bash -c \"zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true\"\n    steps:\n      - uses: actions/checkout@v3\n      - name: Set up Python\n        uses: actions/setup-python@v4\n        with:\n          python-version: '3.9'\n      - name: Install dependencies\n        run: |\n          pip install python-owasp-zap-v2.4 requests\n      - name: Wait for ZAP to start\n        run: sleep 30\n      - name: Run Security Tests\n        run: |\n          python testing/security/owasp-zap-security-tests.py \\\n            --url ${{ secrets.API_BASE_URL }} \\\n            --api-key ${{ secrets.API_KEY }} \\\n            --output security_report.json\n      - name: Upload Security Report\n        uses: actions/upload-artifact@v3\n        with:\n          name: security-report\n          path: security_report.json\n\n  compliance-testing:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n      - name: Set up Python\n        uses: actions/setup-python@v4\n        with:\n          python-version: '3.9'\n      - name: Install dependencies\n        run: pip install requests\n      - name: Run Compliance Tests\n        run: |\n          python testing/compliance/coppa-gdpr-validation-tests.py \\\n            --url ${{ secrets.API_BASE_URL }} \\\n            --api-key ${{ secrets.API_KEY }} \\\n            --output compliance_report.json\n      - name: Upload Compliance Report\n        uses: actions/upload-artifact@v3\n        with:\n          name: compliance-report\n          path: compliance_report.json\n\n  performance-testing:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n      - name: Set up Node.js\n        uses: actions/setup-node@v3\n        with:\n          node-version: '18'\n      - name: Install dependencies\n        run: npm install aws-sdk\n      - name: Configure AWS credentials\n        uses: aws-actions/configure-aws-credentials@v2\n        with:\n          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}\n          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n          aws-region: us-east-1\n      - name: Run Cold Start Tests\n        run: node testing/performance/cold-start-performance-tests.js\n      - name: Upload Performance Report\n        uses: actions/upload-artifact@v3\n        with:\n          name: performance-report\n          path: cold-start-test-results.json\n```\n\n## Local Development Testing\n\n### Quick Test Suite\n\n```bash\n#!/bin/bash\n# run-tests.sh - Quick test suite for local development\n\nset -e\n\nAPI_BASE_URL=\"http://localhost:3000\"\nAPI_KEY=\"test-api-key\"\n\necho \"üöÄ Running Storytailor Test Suite...\"\n\n# 1. Load Testing (reduced iterations for local)\necho \"üìä Running load tests...\"\nk6 run --env API_BASE_URL=$API_BASE_URL \\\n       --env API_KEY=$API_KEY \\\n       --env TEST_ITERATIONS=10 \\\n       testing/load/k6-load-tests.js\n\n# 2. Security Testing (if ZAP is available)\nif command -v zap.sh &> /dev/null; then\n    echo \"üîí Running security tests...\"\n    python testing/security/owasp-zap-security-tests.py \\\n      --url $API_BASE_URL \\\n      --api-key $API_KEY\nelse\n    echo \"‚ö†Ô∏è  ZAP not found, skipping security tests\"\nfi\n\n# 3. Compliance Testing\necho \"üìã Running compliance tests...\"\npython testing/compliance/coppa-gdpr-validation-tests.py \\\n  --url $API_BASE_URL \\\n  --api-key $API_KEY\n\necho \"‚úÖ All tests completed!\"\n```\n\n### Docker Testing Environment\n\n```dockerfile\n# Dockerfile.testing\nFROM node:18-alpine\n\n# Install K6\nRUN apk add --no-cache curl && \\\n    curl -s https://dl.k6.io/key.gpg | apk add --allow-untrusted -X https://dl.k6.io/rpm/stable/x86_64/ k6\n\n# Install Python for security/compliance tests\nRUN apk add --no-cache python3 py3-pip\n\n# Install dependencies\nCOPY package*.json ./\nRUN npm install\n\nCOPY requirements.txt ./\nRUN pip3 install -r requirements.txt\n\n# Copy test files\nCOPY testing/ ./testing/\n\n# Default command\nCMD [\"./run-tests.sh\"]\n```\n\n```bash\n# Build and run testing container\ndocker build -f Dockerfile.testing -t storytailor-tests .\ndocker run -e API_BASE_URL=https://orchestrator.storytailor.com \\\n           -e API_KEY=your-api-key \\\n           storytailor-tests\n```\n\n## Test Data Management\n\n### Test User Accounts\n\n```javascript\n// test-data/users.js\nconst testUsers = {\n  child_under_13: {\n    email: 'child@example.com',\n    age: 10,\n    parentalConsent: true,\n    parentEmail: 'parent@example.com'\n  },\n  teen_user: {\n    email: 'teen@example.com',\n    age: 15,\n    parentalConsent: false\n  },\n  adult_user: {\n    email: 'adult@example.com',\n    age: 25,\n    parentalConsent: false\n  }\n};\n\nmodule.exports = testUsers;\n```\n\n### Test Story Templates\n\n```javascript\n// test-data/stories.js\nconst testStories = {\n  bedtime_story: {\n    type: 'bedtime',\n    prompt: 'A gentle story about a sleepy bunny',\n    expectedElements: ['calm', 'peaceful', 'sleep']\n  },\n  adventure_story: {\n    type: 'adventure',\n    prompt: 'An exciting quest with a brave hero',\n    expectedElements: ['adventure', 'brave', 'quest']\n  },\n  educational_story: {\n    type: 'educational',\n    prompt: 'A story that teaches about friendship',\n    expectedElements: ['learn', 'friendship', 'lesson']\n  }\n};\n\nmodule.exports = testStories;\n```\n\n## Monitoring and Alerting\n\n### CloudWatch Dashboards\n\nThe testing suite automatically publishes metrics to CloudWatch:\n\n- **Performance Metrics**: Response times, throughput, error rates\n- **Security Metrics**: Vulnerability counts, security test results\n- **Compliance Metrics**: Compliance test pass rates, violations\n- **Cold Start Metrics**: Lambda cold start durations, success rates\n\n### Alerting Rules\n\n```yaml\n# cloudwatch-alarms.yml\nPerformanceAlerts:\n  - Name: HighResponseTime\n    MetricName: response_time\n    Threshold: 800\n    ComparisonOperator: GreaterThanThreshold\n    \n  - Name: HighErrorRate\n    MetricName: errors\n    Threshold: 1\n    ComparisonOperator: GreaterThanThreshold\n\nSecurityAlerts:\n  - Name: SecurityVulnerabilities\n    MetricName: high_risk_vulnerabilities\n    Threshold: 0\n    ComparisonOperator: GreaterThanThreshold\n\nComplianceAlerts:\n  - Name: ComplianceViolations\n    MetricName: critical_compliance_issues\n    Threshold: 0\n    ComparisonOperator: GreaterThanThreshold\n```\n\n## Troubleshooting\n\n### Common Issues\n\n1. **K6 Installation Issues**\n   ```bash\n   # macOS\n   brew install k6\n   \n   # Ubuntu/Debian\n   sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69\n   echo \"deb https://dl.k6.io/deb stable main\" | sudo tee /etc/apt/sources.list.d/k6.list\n   sudo apt-get update\n   sudo apt-get install k6\n   ```\n\n2. **ZAP Connection Issues**\n   ```bash\n   # Start ZAP daemon manually\n   zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true\n   \n   # Check if ZAP is running\n   curl http://localhost:8080/JSON/core/view/version/\n   ```\n\n3. **AWS Permissions for Cold Start Tests**\n   ```json\n   {\n     \"Version\": \"2012-10-17\",\n     \"Statement\": [\n       {\n         \"Effect\": \"Allow\",\n         \"Action\": [\n           \"lambda:InvokeFunction\",\n           \"lambda:GetFunctionConfiguration\",\n           \"lambda:UpdateFunctionConfiguration\",\n           \"cloudwatch:PutMetricData\"\n         ],\n         \"Resource\": \"*\"\n       }\n     ]\n   }\n   ```\n\n### Test Environment Setup\n\n```bash\n# Create test environment\npython -m venv test-env\nsource test-env/bin/activate  # Linux/macOS\n# or\ntest-env\\Scripts\\activate  # Windows\n\n# Install Python dependencies\npip install -r testing/requirements.txt\n\n# Install Node.js dependencies\nnpm install\n\n# Set environment variables\nexport API_BASE_URL=\"https://orchestrator.storytailor.com\"\nexport API_KEY=\"your-api-key\"\nexport AWS_REGION=\"us-east-1\"\n```\n\n## Contributing\n\nWhen adding new tests:\n\n1. **Follow naming conventions**: `test-category/test-name.js|py`\n2. **Include documentation**: Add test description and usage examples\n3. **Add CI integration**: Update GitHub Actions workflow\n4. **Include error handling**: Proper error messages and exit codes\n5. **Add metrics**: Publish relevant metrics to CloudWatch\n\n### Test Template\n\n```javascript\n// testing/template/example-test.js\nclass ExampleTester {\n  constructor(config) {\n    this.config = config;\n    this.results = [];\n  }\n  \n  async runTest() {\n    // Test implementation\n  }\n  \n  analyzeResults() {\n    // Results analysis\n  }\n  \n  generateReport() {\n    // Report generation\n  }\n}\n\nmodule.exports = ExampleTester;\n```\n\n## License\n\nThis testing suite is part of the Storytailor Multi-Agent System and follows the same license terms."